<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cat Game</title>

    <style type="text/css">
        html, body {
            margin: 0;
            height: 100%;
            background-color: black;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
    </style>

    <script type="text/javascript">

        const BACKGROUND_COLOR = 'midnightblue';
        const DOT_COLOR = 'gold';
        class Dot {
            constructor(r = 0, x = 0, y = 0, speed = 0, direction = 0) {
                this.r = r;
                this.pos = {
                    _x: x,
                    _y: y,
                    get x() {return this._x},
                    get y() {return this._y}
                };
                this._speed = speed;
                this._direction = this.toRadians(direction);
                this.vel = {
                    _x: 0,
                    _y: 0,
                    get x() {return this._x},
                    get y() {return this._y}
                };

                this.bounds = {
                    x: {min: 0, max: window.innerWidth},
                    y: {min: 0, max: window.innerHeight - 5}
                };

                this.setR(r);
                this.setX(x);
                this.setY(y);
                this.setSpeed(speed);
                this.setDirection(this.toRadians(direction));
            }

            setR(r) {
                this.r = r;
                this.bounds = {
                    x: {min: this.r, max: window.innerWidth - (this.r)},
                    y: {min: this.r, max: window.innerHeight - (this.r) - 5}
                };
            }
            setX(x) {
                this.pos._x = x;
            }
            setY(y) {
                this.pos._y = y;
            }
            setSpeed(speed) {
                this._speed = speed;
                this.vel._x = speed*Math.cos(this._direction);
                this.vel._y = speed*Math.sin(this._direction);
            }
            setDirection(dir) {
                this._direction = dir;
                this.vel._x = this._speed*Math.cos(dir);
                this.vel._y = this._speed*Math.sin(dir);
            }
            toRadians(degrees) {
                return degrees*Math.PI/180;
            }
            bounce(axis) {
                let vx = this.vel.x;
                let vy = this.vel.y;
                if(axis === 'x') {
                    vx *= -1;
                }
                else if(axis === 'y') {
                    vy *= -1;
                }
                else {
                    let ex = new Error(`cannot bounce about unknown axis ${axis}`);
                    ex.name = 'InvalidBounceAxis';
                    throw ex;
                }

                this.setDirection(Math.atan2(vy, vx));
            }

            advance(dt) {
                let [x0, y0] = [this.pos.x, this.pos.y];
                let [dx, dy] = [dt * this.vel.x, dt * this.vel.y];
                let [x1, y1] = [x0 + dx, y0 + dy];

                if(x1 > this.bounds.x.max) {
                    let p = (x1 - this.bounds.x.max) / dx;
                    x1 = this.bounds.x.max - dx * (1 - p);
                    this.bounce('x');
                }
                else if(x1 < this.bounds.x.min) {
                    let p = (x1 - this.bounds.x.min) / dx;
                    x1 = this.bounds.x.min + dx * (1 - p);
                    this.bounce('x');
                }

                if(y1 > this.bounds.y.max) {
                    let p = (y1 - this.bounds.y.max) / dy;
                    y1 = this.bounds.y.max - dy * (1 - p);
                    this.bounce('y');
                }
                else if(y1 < this.bounds.y.min) {
                    let p = (y1 - this.bounds.y.min) / dy;
                    y1 = this.bounds.y.min + dy * (1 - p);
                    this.bounce('y');
                }

                this.setX(x1);
                this.setY(y1);
            }


            paint(ctx) {
                ctx.beginPath();
                ctx.arc(this.pos.x, this.pos.y, this.r, this.r, 0, 0,
                    2*Math.PI);
                ctx.fillStyle = DOT_COLOR;
                ctx.fill();

                return [
                    {x: this.pos.x - this.r - 1, y: this.pos.y - this.r - 1},
                    {x: this.pos.x + this.r + 1, y: this.pos.y + this.r + 1}
                ];
            }
        }

        function paintBG(ctx, x = 0, y = 0,
                         w = window.innerWidth, h = window.innerHeight) {
            ctx.beginPath();
            ctx.rect(x, y, w, h);
            ctx.fillStyle = BACKGROUND_COLOR;
            ctx.fill();
        }
        function resetCanvas() {
            let canvas = document.getElementById('canvas');
            let computed = window.getComputedStyle(canvas);
            canvas.width = Number.parseFloat(computed.width.replace('px', ''));
            canvas.height = Number.parseFloat(computed.height.replace('px', ''));

            paintBG(window.ctx);
        }
        function paint(ctx) {

            let width = window.lastRegion[1].x - window.lastRegion[0].x;
            let height = window.lastRegion[1].y - window.lastRegion[0].y;
            paintBG(window.ctx, window.lastRegion[0].x,window.lastRegion[0].y,
                    width, height);

            window.lastRegion = window.dot.paint(ctx);
        }
        function animateDot(stamp) {
            window.frameRequest = window.requestAnimationFrame(animateDot);

            let frameTime = (stamp - window.lastFrame)/1000;
            window.lastFrame = stamp;
            // if(window.frames % 100 === 0) {
            //     // console.log(frameTime, stamp/window.frames);
            // }

            window.dot.advance(frameTime);
            window.paint(window.ctx);
        }
        function main() {

            let computed = window.getComputedStyle(document.body);
            let width;
            let newWidth;
            let height;
            do {
                width = Number.parseFloat(computed.width.replace('px', ''));
                height = Number.parseFloat(computed.height.replace('px', ''));
                document.body.style.height = `${height - 1}px`;

                computed = window.getComputedStyle(document.body);
                if(height < 300) {
                    break;
                }

                newWidth = Number.parseFloat(computed.width.replace('px', ''));

            } while(newWidth - width === 0);

            let canvas = document.getElementById('canvas');
            canvas.addEventListener('click', () => {
                if(window.frameRequest === false) {
                    window.frameRequest =
                        window.requestAnimationFrame(animateDot);
                }
                else {
                    window.cancelAnimationFrame(window.frameRequest);
                    window.frameRequest = false;
                }
            });

            window.ctx = canvas.getContext('2d');
            resetCanvas();
            window.addEventListener('resize', resetCanvas);

            window.dot = new Dot(20, 250, 100, 150, -45);
            window.lastRegion = [
                {x: 0, y: 0},
                {x: window.innerWidth, y: window.innerHeight}
            ];

            window.lastFrame = performance.now();
            window.frameRequest = window.requestAnimationFrame(animateDot);
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
</head>
<body>

    <canvas id="canvas"></canvas>

</body>
</html>
